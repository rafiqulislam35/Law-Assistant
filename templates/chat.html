<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Icons + Styles -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

  <title>‚öñÔ∏è Law Assistant</title>

  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

  <div class="wrapper">
    <div class="title">‚öñÔ∏è Law Assistant</div>
    <div class="box" id="chatBox"></div>

    <div class="typing-area">
      <div class="input-field">
        <input id="chatInput" type="text" placeholder="Type your message..." required />
        <button id="sendBtn" type="button" aria-label="Send">
          <i class="fa fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const input   = document.getElementById("chatInput");
    const button  = document.getElementById("sendBtn");

    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addUserBubble(text) {
      const el = document.createElement("div");
      el.className = "item right";
      el.innerHTML = `<div class="msg"><p>${text}</p></div>`;
      chatBox.appendChild(el);
      scrollToBottom();
    }

    function addBotBubble(markdownText) {
      const el = document.createElement("div");
      el.className = "item";
      const html = marked.parse(markdownText || "");
      el.innerHTML = `
        <div class="icon"><i class="fa fa-user"></i></div>
        <div class="msg">${html}</div>`;
      chatBox.appendChild(el);
      scrollToBottom();
    }

    function addTyping() {
      const el = document.createElement("div");
      el.className = "item";
      el.id = "typing";
      el.innerHTML = `
        <div class="icon"><i class="fa fa-user"></i></div>
        <div class="msg"><em>typing‚Ä¶</em></div>`;
      chatBox.appendChild(el);
      scrollToBottom();
    }

    function removeTyping() {
      const t = document.getElementById("typing");
      if (t) t.remove();
    }

    async function send() {
      const msg = (input.value || "").trim();
      if (!msg) return;

      // UI: show user message + clear field
      addUserBubble(msg);
      input.value = "";
      input.focus();

      // UI: lock send while awaiting
      button.disabled = true;
      addTyping();

      try {
        // üîÅ Memory-aware route
        const res = await fetch("/memory-chat", {      
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ msg })
        });

        const text = await res.text();
        removeTyping();
        addBotBubble(text);
      } catch (err) {
        console.error(err);
        removeTyping();
        addBotBubble("Sorry‚Äîsomething went wrong. Please try again.");
      } finally {
        button.disabled = false;
      }
    }

    // Click to send
    button.addEventListener("click", send);

    // Enter to send
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") send();
    });
  </script>
</body>
</html>
